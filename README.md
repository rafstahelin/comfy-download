# ComfyUI Download and Sync Manager

## Overview
The ComfyUI Download Manager is a system for automatically monitoring and processing images generated by ComfyUI. It provides a simple command-line interface for managing the download and organization of your AI-generated images, along with automatic backup and bidirectional synchronization of your ComfyUI user settings with Dropbox.

> **Note:** This repository is independent from the [easy](https://github.com/rafstahelin/easy) repository. Each repository should be installed separately.

## Installation

### Standalone Installation
```bash
cd /workspace/comfy-download
chmod +x setup.sh
bash setup.sh
source ~/.bashrc
```

### Installation with Easy [DEPRECATED]
**Note:** As of the latest version, comfy-download should be installed directly, not through the Easy setup. The following installation method is deprecated and no longer supported:

```bash
# DEPRECATED - Do not use this method
cd /workspace/easy
chmod +x setup.sh
bash setup.sh
source ~/.bashrc
```

Instead, install each repository separately to avoid alias conflicts.

## Usage
After installation, the following commands are available:

| Command | Description |
|---------|-------------|
| dl start | Start the automatic download, backup and bidirectional sync system (activates cron jobs) |
| dl stop | Stop the automatic download, backup and bidirectional sync system |
| dl status | Show current download, backup and sync statistics |
| dl report | Generate a comprehensive report of today's operations |
| dl run | Run a download check manually once |
| dl backup | Run a backup of ComfyUI user folder to Dropbox manually |
| dl bisync | Run a bidirectional sync of ComfyUI settings and workflows with Dropbox manually |
| dl bi | Alias for dl bisync |
| dl customsync | Run a custom node data sync manually once |
| dl cs | Alias for dl customsync |
| dl checkconfig | Check and fix custom node configurations |
| dl cc | Alias for dl checkconfig |
| dl reset | Clean up duplicate log entries in the download log |
| dl help | Display command reference |

## How It Works

### Image Downloads
- When you run `dl start`, a cron job is set up to run every minute
- The cron job executes the download script which checks for new images in `/workspace/ComfyUI/output/YYYY-MM-DD/`
- Processed images are logged in `/workspace/ComfyUI/logs/downloaded_YYYY-MM-DD.log`
- Statistics can be viewed at any time using the `dl status` command

### User Settings Backup
- When you run `dl start`, an immediate backup of your ComfyUI user settings is performed
- A cron job is set up to back up your settings every hour
- The backup includes the entire `/workspace/ComfyUI/user/default/` folder
- Files are compressed as a timestamped zip file and uploaded to Dropbox at `dbx:/studio/ai/libs/comfy-data/default-bckp`
- Backup status can be viewed with the `dl status` command
- Manual backups can be triggered with the `dl backup` command

### Bidirectional Synchronization
- When you run `dl start`, an immediate bidirectional sync is performed
- A cron job is set up to sync your settings and workflows every 5 minutes
- The sync includes:
  - `/workspace/ComfyUI/user/default/comfy.templates.json`
  - `/workspace/ComfyUI/user/default/comfy.settings.json`
  - `/workspace/ComfyUI/user/default/workflows/`
- Files are synchronized with Dropbox at `dbx:/studio/ai/libs/comfy-data/default`
- This ensures that when you start a new RunPod container, it will always have your latest workflows and settings
- Manual sync can be triggered with the `dl bisync` command or the shorter `dl bi` command

### Custom Node Data Synchronization
- When you run `dl start`, an immediate custom node data sync is performed
- A cron job is set up to sync custom node data every 30 minutes
- The sync includes:
  - `/workspace/comfy-data/milehighstyler` ↔ `dbx:/studio/ai/libs/comfy-data/milehighstyler`
  - `/workspace/comfy-data/plushparameters` ↔ `dbx:/studio/ai/libs/comfy-data/plushparameters`
  - `/workspace/comfy-data/plushprompts` ↔ `dbx:/studio/ai/libs/comfy-data/plushprompts`
- This ensures that custom node data is synchronized between different RunPod instances
- Manual sync can be triggered with the `dl customsync` command or the shorter `dl cs` command

### Custom Node Configuration Management
- When you run `dl start`, custom node configurations are automatically validated and fixed
- A cron job is set up to check configurations every 6 hours
- The checker manages:
  - Plush-for-ComfyUI configuration (`/workspace/ComfyUI/custom_nodes/Plush-for-ComfyUI/user/text_file_dirs.json`)
  - ComfyUI-Easy-Use styles symlink (`/workspace/ComfyUI/custom_nodes/ComfyUI-Easy-Use/styles`)
- Manual configuration check can be triggered with the `dl checkconfig` command or the shorter `dl cc` command

## Directory Structure

- `/workspace/comfy-download/` - Scripts and configuration
- `/workspace/ComfyUI/output/YYYY-MM-DD/` - Generated images organized by date
- `/workspace/ComfyUI/logs/` - Download, backup, and sync logs
- `/workspace/ComfyUI/user/default/` - User settings synchronized with Dropbox
  - `/workspace/ComfyUI/user/default/workflows/` - Workflows synchronized with Dropbox
  - `/workspace/ComfyUI/user/default/comfy.templates.json` - Templates synchronized with Dropbox
  - `/workspace/ComfyUI/user/default/comfy.settings.json` - Settings synchronized with Dropbox
- `/workspace/comfy-data/` - Custom node data synchronized with Dropbox
  - `/workspace/comfy-data/milehighstyler/` - MileHighStyler data for ComfyUI-Easy-Use
  - `/workspace/comfy-data/plushparameters/` - Parameter files for Plush-for-ComfyUI
  - `/workspace/comfy-data/plushprompts/` - Prompt files for Plush-for-ComfyUI
- `/tmp/comfyui-backup/` - Temporary location for zip files during backup

## Troubleshooting

### Common Issues

- **"Command not found" when running dl commands**
  - Ensure you've sourced your bashrc: `source ~/.bashrc`
  - Check if the alias is correctly defined: `grep "alias dl=" ~/.bashrc`
  - Verify script path: `ls -la /workspace/comfy-download/dl-manager.sh`

- **No images being processed**
  - Check if ComfyUI is generating images to the expected directory
  - Verify directory permissions: `ls -la /workspace/ComfyUI/output/`
  - Run manually once to debug: `dl run`

- **Backup or sync not working**
  - Verify rclone is properly configured: `rclone config`
  - Check if source directory exists: `ls -la /workspace/ComfyUI/user/default`
  - Check backup log: `cat /workspace/ComfyUI/logs/backup.log`
  - Check sync log: `cat /workspace/ComfyUI/logs/bisync.log`
  - Try running backup or sync manually: `dl backup` or `dl bisync`

- **Bidirectional sync conflicts**
  - If you encounter conflicts, run a forced sync with: `dl bisync`
  - Check the bisync log for details: `cat /workspace/ComfyUI/logs/bisync.log`
  - If necessary, you can ensure fresh sync by deleting the sync state: `rm -f /workspace/ComfyUI/user/default/.rclone-bisync*`

- **Custom node sync issues**
  - Check if custom node data directories exist: `ls -la /workspace/comfy-data/`
  - Check custom sync log: `cat /workspace/ComfyUI/logs/custom_sync.log`
  - Try running custom sync manually: `dl customsync`

- **Custom node configuration issues**
  - Check if custom nodes are installed: `ls -la /workspace/ComfyUI/custom_nodes/`
  - Check configuration log: `cat /workspace/ComfyUI/logs/node_config.log`
  - Run configuration check manually: `dl checkconfig`

- **Cron job not running**
  - Check cron service status: `service cron status`
  - View current cron jobs: `crontab -l`
  - Check system logs: `grep CRON /var/log/syslog`

- **Alias conflicts with other repositories**
  - If you're experiencing alias conflicts, run: `/workspace/comfy-download/fix-aliases.sh`
  - Then reload your shell configuration: `source ~/.bashrc`

### Advanced Debugging

For more detailed debugging:

- Check script execution directly:
  ```bash
  bash -x /workspace/comfy-download/dl-manager.sh help
  bash -x /workspace/comfy-download/backup_comfyui.sh force
  bash -x /workspace/comfy-download/bisync_comfyui.sh force
  bash -x /workspace/comfy-download/custom_sync.sh force
  bash -x /workspace/comfy-download/node_config_checker.sh apply
  ```

- Verify file permissions:
  ```bash
  chmod +x /workspace/comfy-download/*.sh
  ```

- Monitor sync operations in real-time:
  ```bash
  tail -f /workspace/ComfyUI/logs/bisync.log
  tail -f /workspace/ComfyUI/logs/custom_sync.log
  ```

- Test rclone connectivity:
  ```bash
  rclone lsd dbx:
  ```

## Performance Considerations

### Optimizing Workflow Size
For best performance with the bidirectional sync:
- Keep your workflow directory size under 30MB if possible (20-30MB is ideal)
- Consider moving rarely used or archived workflows to a separate location outside the synced directory
- The sync process might take longer with larger workflow directories
- A staged approach to transition from 100MB to 30MB might be:
  1. First, identify and move archived/rarely used workflows to a non-synced archive folder
  2. Organize remaining workflows into logical subfolders
  3. Consider compressing complex workflows where possible

## Version History

- v1.0.0 - Initial release with basic download functionality
- v1.1.0 - Integration with Easy system and improved aliasing
- v1.2.0 - Added automatic backup of ComfyUI user settings to Dropbox
- v1.3.0 - Added bidirectional sync of templates, settings, and workflows with Dropbox
- v1.4.0 - Replaced hyphenated commands with space-separated commands for improved usability
- v1.5.0 - Separated from Easy repository for independent installation and management
- v1.6.0 - Added custom node data synchronization and configuration management

## License
See LICENSE file for details.