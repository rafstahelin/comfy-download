# ComfyUI Download Manager

## Overview
The ComfyUI Download Manager is a system for automatically monitoring and processing images generated by ComfyUI. It provides a simple command-line interface for managing the download and organization of your AI-generated images, along with automatic backup of your ComfyUI user settings to Dropbox.

## Installation

### Standalone Installation
```bash
cd /workspace/comfy-download
chmod +x setup.sh
bash setup.sh
source ~/.bashrc
```

### Installation with Easy
The download manager is automatically installed when you run the Easy setup script:
```bash
cd /workspace/easy
chmod +x setup.sh
bash setup.sh
source ~/.bashrc
```

## Usage
After installation, the following commands are available:

| Command | Description |
|---------|-------------|
| dl start | Start the automatic download and backup system (activates cron jobs) |
| dl stop | Stop the automatic download and backup system |
| dl status | Show current download and backup statistics |
| dl run | Run a download check manually once |
| dl backup | Run a backup of ComfyUI user folder to Dropbox manually |
| dl reset | Clean up duplicate entries in the log file |
| dl help | Display command reference |

## How It Works

### Image Downloads
- When you run `dl start`, a cron job is set up to run every minute
- The cron job executes the download script which checks for new images in `/workspace/ComfyUI/output/YYYY-MM-DD/`
- Processed images are logged in `/workspace/ComfyUI/logs/downloaded_YYYY-MM-DD.log`
- Statistics can be viewed at any time using the `dl status` command

### User Settings Backup
- When you run `dl start`, an immediate backup of your ComfyUI user settings is performed
- A cron job is set up to back up your settings every hour
- The backup includes the entire `/workspace/ComfyUI/user/default/` folder
- Files are compressed as a timestamped zip file and uploaded to your Dropbox
- Backup status can be viewed with the `dl status` command
- Manual backups can be triggered with the `dl backup` command

## Directory Structure

- `/workspace/comfy-download/` - Scripts and configuration
- `/workspace/ComfyUI/output/YYYY-MM-DD/` - Generated images organized by date
- `/workspace/ComfyUI/logs/` - Download and backup logs
- `/workspace/ComfyUI/user/default/` - User settings backed up to Dropbox
- `/tmp/comfyui-backup/` - Temporary location for zip files during backup

## Troubleshooting

### Common Issues

- **"Command not found" when running dl commands**
  - Ensure you've sourced your bashrc: `source ~/.bashrc`
  - Check if the alias is correctly defined: `grep "alias dl=" ~/.bashrc`
  - Verify script path: `ls -la /workspace/comfy-download/dl-manager.sh`

- **No images being processed**
  - Check if ComfyUI is generating images to the expected directory
  - Verify directory permissions: `ls -la /workspace/ComfyUI/output/`
  - Run manually once to debug: `dl run`

- **Backup not working**
  - Verify rclone is properly configured: `rclone config`
  - Check if source directory exists: `ls -la /workspace/ComfyUI/user/default`
  - Check backup log: `cat /workspace/ComfyUI/logs/backup.log`
  - Try running backup manually: `dl backup`

- **Cron job not running**
  - Check cron service status: `service cron status`
  - View current cron jobs: `crontab -l`
  - Check system logs: `grep CRON /var/log/syslog`

### Advanced Debugging

For more detailed debugging:

- Check script execution directly:
  ```bash
  bash -x /workspace/comfy-download/dl-manager.sh help
  bash -x /workspace/comfy-download/backup_comfyui.sh force
  ```

- Verify file permissions:
  ```bash
  chmod +x /workspace/comfy-download/*.sh
  ```

- Create test images to validate processing:
  ```bash
  mkdir -p /workspace/ComfyUI/output/$(date +%Y-%m-%d)
  touch /workspace/ComfyUI/output/$(date +%Y-%m-%d)/test_image.png
  dl run
  ```

## Maintenance

### Adding New Features

To add new features to the download manager:

- Update the dl-manager.sh script to add new command options
- Modify the help text to document new commands
- Update any affected paths or dependencies
- Test thoroughly before committing changes

## Version History

- v1.0.0 - Initial release with basic download functionality
- v1.1.0 - Integration with Easy system and improved aliasing
- v1.2.0 - Added automatic backup of ComfyUI user settings to Dropbox

## License
See LICENSE file for details.